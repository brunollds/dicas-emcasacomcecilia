name: Publish Promotion

on:
  workflow_dispatch:
    inputs:
      payload:
        description: "JSON com os dados da promoÃ§Ã£o"
        required: true

permissions:
  contents: write

concurrency:
  group: publish-promo
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ§¾ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt || true

      - name: ðŸ“¥ Salvar payload recebido
        run: |
          echo '${{ inputs.payload }}' > promo_payload.json

      - name: ðŸ”Ž Validar payload JSON
        run: |
          python - << 'EOF'
          import json, sys

          required = ["produto", "preco", "loja", "link"]

          try:
              data = json.load(open("promo_payload.json", encoding="utf-8"))
          except Exception as e:
              print("âŒ Payload invÃ¡lido:", e)
              sys.exit(1)

          missing = [k for k in required if not data.get(k)]
          if missing:
              print("âŒ Campos obrigatÃ³rios ausentes:", missing)
              sys.exit(1)

          if not isinstance(data["preco"], (int, float)):
              print("âŒ PreÃ§o invÃ¡lido")
              sys.exit(1)

          print("âœ… Payload vÃ¡lido")
          EOF

      - name: ðŸ§  Atualizar products.json
        run: |
          python scripts/publish_from_payload.py promo_payload.json

      - name: ðŸ” Verificar se houve mudanÃ§a
        run: |
          if git diff --quiet; then
            echo "âš ï¸ Nenhuma alteraÃ§Ã£o detectada. Abortando commit."
            exit 0
          fi

      - name: ðŸ’¾ Commit e push
        run: |
          git config user.name "dicas-admin-bot"
          git config user.email "admin@dicas.emcasacomcecilia.com"
          git add products.json
          git commit -m "promo: nova oferta publicada"
          git push
